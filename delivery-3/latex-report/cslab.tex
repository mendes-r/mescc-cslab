\documentclass[11pt]{article}

\usepackage[a4paper,
            bindingoffset=0.5cm,
            left=3cm,
            right=3cm,
            top=3cm,
            bottom=4cm,
            footskip=1.5cm]{geometry}
            
%
\usepackage[T1]{fontenc}
\usepackage{graphicx}
\usepackage{enumitem}
\usepackage{blindtext}
\usepackage{float}
\usepackage{multirow}
\usepackage{minted}
 \usepackage{url}
 \usepackage{amsmath}
 \usepackage[table,xcdraw]{xcolor}
%

\setcounter{secnumdepth}{3}

%%%%%%%%%%%%%%%%%%%%%
\title{\textbf{Critical Systems Lab - MESCC\\ Water Pumping Automated System}}
\date{ISEP, January 2024, \textbf{Third Delivery}}
\author{Ricardo Mendes\\ 1201779
\and Arthur Gerbelli\\ 1220201}
%%%%%%%%%%%%%%%%%%%%%

\begin{document}

\maketitle              
\newpage
\tableofcontents
\newpage

%
\section{Introduction}

As this is the last report, we will try to summarize all the previous analyses, with the main focus being to achieve a conclusion and not only repeat the specificities of the last reports. 

Although the following chapters are tightly defined, the report should be read as a whole. 

%%%
\section{Requirement Specifications}

%%%
\subsection{System Requirements}

There was no change in the system requirements. Below, we listed all the identified system requirements and a comment about its implementation on the prototype. 

\begin{enumerate}[leftmargin=4em, font=\small, label=\textbf{SR-\arabic*}]
	\setlength\itemsep{.5em}
	\item 

		\begin{enumerate}[leftmargin=1.5em, font=\small, label=\textbf{.\arabic*:}]
		\setlength\itemsep{0em}
		\item While the water level is above the minimum level, WPS shall have a pump working. \colorbox{green}{Implemented}
		\item When the water level is below minimum level, WPS shall have all pumps stopped. \colorbox{green}{Implemented}
		\item If the water level is above the maximum level, then the WPS shall trigger an alarm at the Remote Status Station (RSS). \colorbox{green}{Implemented}
		\item A second pump shall be turned on only when the water level is above 2/3 the maximum water level. \colorbox{green}{Implemented}
		\item When only one pump is available, the maximum water level shall be reduced to 2/3. \colorbox{green}{Implemented}
		\item If the readings of the sensor are uneven, the system shall choose the worst case scenario, following the table below:  \colorbox{green}{Implemented}
		
\begin{table}[H]
\begin{tabular}{lllllll}
                                &                                 & \multicolumn{5}{c}{sensor \#1}                                                                                                                                          \\ \cline{3-7} 
                                & \multicolumn{1}{l|}{}           & \multicolumn{1}{l|}{\textbf{0}} & \multicolumn{1}{l|}{\textbf{1}} & \multicolumn{1}{l|}{\textbf{2}} & \multicolumn{1}{l|}{\textbf{3}} & \multicolumn{1}{l|}{\textbf{4}} \\ \cline{2-7} 
\multicolumn{1}{l|}{}           & \multicolumn{1}{l|}{\textbf{0}} & \multicolumn{1}{l|}{-}          & \multicolumn{1}{l|}{1}          & \multicolumn{1}{l|}{2}          & \multicolumn{1}{l|}{3}          & \multicolumn{1}{l|}{4}          \\ \cline{2-7} 
\multicolumn{1}{l|}{}           & \multicolumn{1}{l|}{\textbf{1}} & \multicolumn{1}{l|}{1}          & \multicolumn{1}{l|}{1}          & \multicolumn{1}{l|}{1}          & \multicolumn{1}{l|}{1}          & \multicolumn{1}{l|}{4}          \\ \cline{2-7} 
\multicolumn{1}{l|}{sensor \#2} & \multicolumn{1}{l|}{\textbf{2}} & \multicolumn{1}{l|}{2}          & \multicolumn{1}{l|}{1}          & \multicolumn{1}{l|}{2}          & \multicolumn{1}{l|}{2}          & \multicolumn{1}{l|}{4}          \\ \cline{2-7} 
\multicolumn{1}{l|}{}           & \multicolumn{1}{l|}{\textbf{3}} & \multicolumn{1}{l|}{3}          & \multicolumn{1}{l|}{1}          & \multicolumn{1}{l|}{2}          & \multicolumn{1}{l|}{3}          & \multicolumn{1}{l|}{4}          \\ \cline{2-7} 
\multicolumn{1}{l|}{}           & \multicolumn{1}{l|}{\textbf{4}} & \multicolumn{1}{l|}{4}          & \multicolumn{1}{l|}{4}          & \multicolumn{1}{l|}{4}          & \multicolumn{1}{l|}{4}          & \multicolumn{1}{l|}{4}          \\ \cline{2-7} 
\end{tabular}
\end{table}

\textbf{1}: below min; \textbf{2}: above min; \textbf{3}: above med; \textbf{4}: above max.

\textbf{0}: no connection to the sensor - if both sensors are unavailable, the alarm shall be triggered.
		\end{enumerate}
		
	\item
		\begin{enumerate}[leftmargin=1.5em, font=\small, label=\textbf{.\arabic*:}]
		\setlength\itemsep{0em}
		\item The status of all WPS shall be displayed on all RSS. \colorbox{yellow}{Partially Implemented:} \textcolor{gray}{the hadware available was not enough to add a second WPS and RSS.}
		\item If the alarm is ON, the button in the RSS shall only disable it. \colorbox{green}{Implemented}
		\item The RSS shall have an independent power supply from the WPS. \colorbox{pink}{Not Implemented}
		\item The alarm on the RSS shall have an independent power supply from the RSS itself and from the WPS. \colorbox{pink}{Not Implemented}
		\end{enumerate}
	
	\item	
		\begin{enumerate}[leftmargin=1.5em, font=\small, label=\textbf{.\arabic*:}]
		\setlength\itemsep{0em}
		\item The status of all WPS shall be visible on a web page. \colorbox{green}{Implemented}
		\end{enumerate}

	\item
		\begin{enumerate}[leftmargin=1.5em, font=\small, label=\textbf{.\arabic*:}]
		\setlength\itemsep{0em}
		\item To improve the system´s communication reliability, a cluster of 2(two) MQTT brokers shall be deployed. \colorbox{pink}{Not Implemented} 
		\end{enumerate}

\end{enumerate}

%%%
\subsection{Hazard Analysis}

We added one more entry to the hazard analysis, H-9. Below, we added some comments about the implementation of the identified mitigations in the prototype.

\begin{enumerate}[leftmargin=4em, font=\small, label=\textbf{H-\arabic*:}]
	\setlength\itemsep{.5em}
	\item see SR-1.5
	\item 
		\begin{itemize}
		\setlength\itemsep{0em}
    		\item \textbf{Description:} Both pumps stopped working.
    		\item \textbf{Mitigation:} Trigger alarm. \colorbox{green}{Implemented} 
		\end{itemize} 	
	\item 
		\begin{itemize}
		\setlength\itemsep{0em}
    		\item \textbf{Description:} A pump doesn't turn OFF when the water level in bellow minimum.
    		\item \textbf{Mitigation:} Trigger alarm. \colorbox{pink}{Not Implemented} 
		\end{itemize} 
	\item see SR-1.6
	\item see SR-2.3 and SR-2.4
	\item 
		\begin{itemize}
		\setlength\itemsep{0em}
    		\item \textbf{Description:} RSS are not getting information from WPS.
    		\item \textbf{Mitigation:} Implement a cluter of MQTT Brokers or remove this single point of failure by adopting DDS. Trigger alarm. \colorbox{yellow}{Partially Implemented:} \textcolor{gray}{the alarm is triggered}

		\end{itemize} 
	\item 
		\begin{itemize}
		\setlength\itemsep{0em}
    		\item \textbf{Description:} RSS stops working.
    		\item \textbf{Mitigation:} Have redundancy by having multiple RSS and each one displaying all statuses from all WPS. \colorbox{pink}{Not Implemented} 
		\end{itemize} 
	\item 
		\begin{itemize}
		\setlength\itemsep{0em}
    		\item \textbf{Description:} Control Unit stops working.
    		\item \textbf{Mitigation:} Implement redundancy by having a cluster of nodes running the Control Unit. If the number of nodes is 3 we can implement a voting system and run the same process with the same input in parallel. This would improve the system's fault tolerance. \colorbox{pink}{Not Implemented} 
		\end{itemize} 
	\item
		\begin{itemize}
		\setlength\itemsep{0em}
    		\item \textbf{Description:} Rapid wear of the first water pump.
    		\item \textbf{Mitigation:}  Distribute evenly the work done by the pumps. This can be done, by choosing a random pump when one is need first. \colorbox{pink}{Not Implemented} 
		\end{itemize} 
\end{enumerate}

%%%
\subsection{System Structure and Traceability}

This last chapter tries to map the implementation of the prototype to the model developed during the previous two deliveries.

During the implementation of the system, we noticed that the Web Server is a subsystem independent of the RSS. 

Although, both are ways to visualize the WPS status, they have very different objectives and levels of criticality. The RSS must alert the maintenance team; the web version is, in our understanding, only a nice thing to have. And most of all, we can remove one service without affecting the other. Because of this, we made some changes to the System Structure diagram, as it is possible to visualize below.

\begin{figure}[H]
  \centering
  \includegraphics[width=300px]{../diagrams/system-structure.png}
  \caption{System Structure diagram}
  \label{fig:System Structure Diagram}
\end{figure}

\begin{figure}[H]
  \centering
  \includegraphics[width=\linewidth]{../diagrams/deployment-diagram.jpg}
  \caption{Deployment diagram}
  \label{fig:Deployment Diagram}
\end{figure}

\newpage
%%%
\section{Implementation}

%%%
\subsection{CCSYA - Assembly}

- mostrar codigo da implementacao
- um dos comentarios no codigo de assembly está mal (beq)

%%%
\subsection{RTAES - Concorrency and Real Time Scheduling}

%%%
\subsubsection{Real Time Scheduling}

\begin{table}[!htb]
    \caption{Theoretical values (left) and implemented values (right) in \textit{ms}:}
    \begin{minipage}{0.7\linewidth}
		\begin{table}[H]
		\begin{tabular}{lll}
		\textbf{Task} & \textbf{Ci} & \textbf{Ti} \\
		\textbf{1}    & 60         & 100           \\
		\textbf{2}    & 25         & 200           \\
		\textbf{3}    & 35         & 250          
		\end{tabular}
		\label{table:rt-1}
		\end{table}

    \end{minipage}%
    \begin{minipage}{.5\linewidth}
		\begin{table}[H]
		\begin{tabular}{lll}
		\textbf{Task} & \textbf{Ci} & \textbf{Ti} \\
		\textbf{1}    & 1200         & 2000           \\
		\textbf{2}    & 500         & 4000           \\
		\textbf{3}    & 700         & 5000          
		\end{tabular}
		\label{table:rt-2}
		\end{table}

    \end{minipage} 
\end{table}

The values on the right side table were achieved by running the code in different situations. A closer look, shows that we incresed the values \textbf{x 20}.

To track the execution time we added the following code to each task:

\begin{minted}{c}
for (;;) {
    unsigned long start_time = millis();
    unsigned long finish_time;
    unsigned long duration;

    // Code -------------------

    finish_time = millis();      
    duration = finish_time - start_time;
    Serial.print("TASK N - Execution Time[ms]: ");
    Serial.println(duration); 
}
\end{minted}

\noindent
And here is some of the outputs:

\begin{minted}{bash}
TASK 3 - Duration[ms]: 40
TASK 1 - Duration[ms]: 917
TASK 2 - Duration[ms]: 475
TASK 1 - Duration[ms]: 658
TASK 1 - Duration[ms]: 754
TASK 3 - Duration[ms]: 770  < above WCET
TASK 2 - Duration[ms]: 476
TASK 1 - Duration[ms]: 649
TASK 1 - Duration[ms]: 799
TASK 3 - Duration[ms]: 29
TASK 2 - Duration[ms]: 477
TASK 1 - Duration[ms]: 176
TASK 1 - Duration[ms]: 997
TASK 2 - Duration[ms]: 481
TASK 1 - Duration[ms]: 187
TASK 3 - Duration[ms]: 157
TASK 1 - Duration[ms]: 990
TASK 2 - Duration[ms]: 475
TASK 1 - Duration[ms]: 1036
\end{minted}

The execution time of task 2 that was calculated in the last report is very close to the measured values. Because of this, we needed to add a sleep function to increase its execution.
However, task 1 and task 3 execution time was poorly estimated. This is because of the latency during the TCP and MQTT requests.

To simulate the conclusions from the schedulability analysis, we also increased the periods - as visible in the table \ref{table:rt-2}.

Also, to control that the tasks didn't extended beyond its deadline, we added the following code:

\begin{minted}{c}
long next_release = 5000 - duration; // 5 seconds deadline for Task 3
if (next_release > 0) {
    vTaskDelay(next_release / portTICK_PERIOD_MS);
} else {
    Serial.println("TRASK 3 - FAILED Deadline !!!");
}
\end{minted}

In some cases, task 1 failed the deadline by a couple of miliseconds. Because we defined a timeout value of 2 second, when the request to the two sensors fail, we get this result.

\begin{minted}{bash}
TASK 1 - Connection failed: 172.20.10.13
TASK 1 - Connection failed: 172.20.10.5
TASK 1 - Duration[ms]: 2009
TASK 1 - FAILED Deadline !!!
\end{minted}


connection timeout = 1s
that gives a lot of timeouts. specially with one of the sensors
mitigation.

%%%
\subsubsection{Concorrency}

- mostrar codigo da implementacao

- onde mutex

%%%
\subsection{COMCS - Communication}

- TCP pull strategy

- Arthur

%%%
\subsection{Prototype}

\subsubsection{Overview}

- diagram if implementation

\subsubsection{WPS}

- explicar a tabela dos inputs dos sensores e levantar alarm caso (A tabela agora é diferente da ultima vez)
- strategy for cluster of control unit nodes

- dois timeouts dos sensores equivale a max level.... nao devia estar assim

\subsubsection{MQTT Broker}

- one topic per WPS

\subsubsection{RSS}

- reads broker every 1 sec
- sends alert after 15 sec without message
- subscribes to each WPS topics (iter)
- log who clicked the button and maintain LED on... because the system heals it self 

\subsubsection{Web Server}

%%%
\section{Team Work}


%%%%%%%%%%%%%%%%%%%%%
\newpage
\begin{thebibliography}{8}

\bibitem{c1}
 Espressif documentation: {\url{https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/freertos_idf.html#id23/}}

\end{thebibliography}

\end{document}
